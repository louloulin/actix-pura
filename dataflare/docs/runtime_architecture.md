# DataFlare 运行时架构详细设计

## 1. 架构概览

DataFlare 运行时架构采用分层设计，每一层都有明确的职责和接口。下图展示了整体架构：

```
┌───────────────────────────────────────────────────────────────────────┐
│                           应用层                                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │  CLI 工具    │  │  API 服务    │  │  Web 界面   │  │  第三方集成   │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │
└───────────────────────────────────────────────────────────────────────┘
                                 ↑
                                 │
┌───────────────────────────────────────────────────────────────────────┐
│                           核心层                                        │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                      工作流执行引擎                                │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │  连接器系统  │  │  处理器系统  │  │  插件系统   │  │  状态管理    │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │
└───────────────────────────────────────────────────────────────────────┘
                                 ↑
                                 │
┌───────────────────────────────────────────────────────────────────────┐
│                           基础层                                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │  Actor 系统  │  │  消息传递   │  │  序列化     │  │  安全性      │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │
│                                                                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │  监控和指标  │  │  日志记录   │  │  配置管理   │  │  错误处理    │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │
└───────────────────────────────────────────────────────────────────────┘
```

## 2. 运行时模式详细设计

### 2.1 单节点模式

单节点模式下，所有组件在同一进程中运行，适合开发环境和小规模部署。

```
┌─────────────────────────────────────────────────────────────────┐
│                      DataFlare 进程                              │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    工作流执行引擎                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌───────────┐   ┌───────────┐   ┌───────────┐                  │
│  │ 源连接器   │ → │  处理器   │ → │ 目标连接器 │                  │
│  └───────────┘   └───────────┘   └───────────┘                  │
│                                                                  │
│  ┌───────────────────┐   ┌───────────────────┐                  │
│  │    插件系统       │   │    状态管理        │                  │
│  └───────────────────┘   └───────────────────┘                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 边缘模式 (Edge Mode)

边缘模式针对资源受限环境优化，减少资源消耗并支持离线操作。

```
┌─────────────────────────────────────────────────────────────────┐
│                 DataFlare Edge Runtime                           │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                轻量级工作流执行引擎                       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌───────────┐   ┌───────────┐   ┌───────────┐                  │
│  │ 本地数据   │ → │ 优化处理器 │ → │ 本地存储   │                  │
│  │ 采集器     │   │           │   │          │                  │
│  └───────────┘   └───────────┘   └───────────┘                  │
│                                                                  │
│  ┌───────────────────┐   ┌───────────────────┐                  │
│  │   离线缓存        │   │   同步管理器       │                  │
│  └───────────────────┘   └───────────────────┘                  │
│                                ↑↓                               │
└────────────────────────────────┼──────────────────────────────┘
                                 │
┌────────────────────────────────┼──────────────────────────────┐
│                                ↓                               │
│  ┌───────────────────────────────────────────────────────┐    │
│  │                     云端服务                            │    │
│  └───────────────────────────────────────────────────────┘    │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 2.3 云模式 (Cloud Mode)

云模式支持分布式部署和大规模数据处理，包含多个协同工作的节点。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         DataFlare Cloud Runtime                          │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                        协调器节点                                 │    │
│  │                                                                  │    │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐     │    │
│  │  │  集群管理器     │  │  任务调度器     │  │  状态协调器     │     │    │
│  │  └────────────────┘  └────────────────┘  └────────────────┘     │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                     ↑            ↑             ↑                         │
│                     │            │             │                         │
│                     ↓            ↓             ↓                         │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐         │
│  │ Worker 节点 │  │ Worker 节点 │  │ Worker 节点 │  │ Worker 节点 │ ...   │
│  │            │  │            │  │            │  │            │         │
│  │ ┌────────┐ │  │ ┌────────┐ │  │ ┌────────┐ │  │ ┌────────┐ │         │
│  │ │源连接器 │ │  │ │处理器   │ │  │ │处理器   │ │  │ │目标连接器│ │         │
│  │ └────────┘ │  │ └────────┘ │  │ └────────┘ │  │ └────────┘ │         │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## 3. 核心组件详细设计

### 3.1 工作流执行引擎

工作流执行引擎是 DataFlare 的核心，负责协调整个数据处理流程。

```
┌─────────────────────────────────────────────────────────────────┐
│                      工作流执行引擎                               │
│                                                                  │
│  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐      │
│  │ 工作流解析器   │ → │ 工作流验证器   │ → │ 工作流执行器   │      │
│  └───────────────┘   └───────────────┘   └───────────────┘      │
│                                             │                    │
│  ┌───────────────┐                         │                    │
│  │ 工作流监控器   │ ←─────────────────────────                    │
│  └───────────────┘                                              │
│                                                                  │
│  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐      │
│  │ 错误处理器     │   │ 恢复管理器     │   │ 资源管理器     │      │
│  └───────────────┘   └───────────────┘   └───────────────┘      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 关键组件：

- **WorkflowParser**：解析工作流定义（YAML、JSON 等）
- **WorkflowValidator**：验证工作流的正确性和完整性
- **WorkflowExecutor**：执行工作流，协调各个组件
- **WorkflowMonitor**：监控工作流执行状态和进度
- **ErrorHandler**：处理执行过程中的错误
- **RecoveryManager**：从故障中恢复工作流执行
- **ResourceManager**：管理执行过程中的资源分配

### 3.2 连接器系统

连接器系统负责与外部数据源和目标进行交互。

```
┌─────────────────────────────────────────────────────────────────┐
│                         连接器系统                                │
│                                                                  │
│  ┌───────────────────────┐      ┌───────────────────────┐       │
│  │      源连接器          │      │      目标连接器        │       │
│  │                       │      │                       │       │
│  │  ┌───────────────┐    │      │  ┌───────────────┐    │       │
│  │  │ 全量提取模式   │    │      │  │ 覆盖写入模式   │    │       │
│  │  └───────────────┘    │      │  └───────────────┘    │       │
│  │                       │      │                       │       │
│  │  ┌───────────────┐    │      │  ┌───────────────┐    │       │
│  │  │ 增量提取模式   │    │      │  │ 追加写入模式   │    │       │
│  │  └───────────────┘    │      │  └───────────────┘    │       │
│  │                       │      │                       │       │
│  │  ┌───────────────┐    │      │  ┌───────────────┐    │       │
│  │  │ CDC 提取模式   │    │      │  │ 更新写入模式   │    │       │
│  │  └───────────────┘    │      │  └───────────────┘    │       │
│  └───────────────────────┘      └───────────────────────┘       │
│                                                                  │
│  ┌───────────────────────┐      ┌───────────────────────┐       │
│  │    连接器注册表        │      │    连接器工厂          │       │
│  └───────────────────────┘      └───────────────────────┘       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 关键组件：

- **SourceConnector**：数据源连接器接口
- **DestinationConnector**：数据目标连接器接口
- **ConnectorRegistry**：管理所有可用的连接器
- **ConnectorFactory**：创建连接器实例
- **提取模式**：全量、增量、CDC
- **写入模式**：覆盖、追加、更新

### 3.3 处理器系统

处理器系统负责数据转换和处理。

```
┌─────────────────────────────────────────────────────────────────┐
│                         处理器系统                                │
│                                                                  │
│  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐      │
│  │ 映射处理器     │   │ 过滤处理器     │   │ 聚合处理器     │      │
│  └───────────────┘   └───────────────┘   └───────────────┘      │
│                                                                  │
│  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐      │
│  │ 丰富处理器     │   │ 连接处理器     │   │ 自定义处理器   │      │
│  └───────────────┘   └───────────────┘   └───────────────┘      │
│                                                                  │
│  ┌───────────────────────┐      ┌───────────────────────┐       │
│  │    处理器注册表        │      │    处理器工厂          │       │
│  └───────────────────────┘      └───────────────────────┘       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 关键组件：

- **Processor**：处理器接口
- **MappingProcessor**：字段映射和转换
- **FilterProcessor**：数据过滤
- **AggregateProcessor**：数据聚合
- **EnrichmentProcessor**：数据丰富
- **JoinProcessor**：数据连接
- **ProcessorRegistry**：管理所有可用的处理器
- **ProcessorFactory**：创建处理器实例

### 3.4 插件系统

插件系统允许通过 WebAssembly (WASM) 扩展 DataFlare 的功能。

```
┌─────────────────────────────────────────────────────────────────┐
│                         插件系统                                  │
│                                                                  │
│  ┌───────────────────────┐      ┌───────────────────────┐       │
│  │    插件管理器          │      │    插件注册表          │       │
│  └───────────────────────┘      └───────────────────────┘       │
│                                                                  │
│  ┌───────────────────────┐      ┌───────────────────────┐       │
│  │    WASM 运行时         │      │    插件沙箱           │       │
│  └───────────────────────┘      └───────────────────────┘       │
│                                                                  │
│  ┌───────────────────────────────────────────────────────┐      │
│  │                    插件 API                            │      │
│  │                                                        │      │
│  │  ┌───────────────┐   ┌───────────────┐   ┌───────────┐│      │
│  │  │ 处理器插件 API │   │ 连接器插件 API │   │ 工具插件 API││      │
│  │  └───────────────┘   └───────────────┘   └───────────┘│      │
│  └───────────────────────────────────────────────────────┘      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 关键组件：

- **PluginManager**：管理插件的生命周期
- **PluginRegistry**：注册和查找插件
- **WasmRuntime**：执行 WASM 模块
- **PluginSandbox**：提供安全的执行环境
- **PluginAPI**：插件与系统交互的接口

## 4. 运行时生命周期

DataFlare 运行时的生命周期包括以下阶段：

1. **初始化**：加载配置，初始化组件
2. **准备**：解析和验证工作流，创建执行计划
3. **执行**：运行工作流，处理数据
4. **监控**：跟踪执行状态和进度
5. **完成/恢复**：正常完成或从故障中恢复
6. **清理**：释放资源，关闭连接

## 5. 扩展点

DataFlare 运行时提供以下扩展点：

1. **连接器 API**：创建自定义数据源和目标连接器
2. **处理器 API**：实现自定义数据转换逻辑
3. **插件系统**：通过 WASM 扩展功能
4. **状态存储**：自定义状态存储后端
5. **监控集成**：与外部监控系统集成
6. **安全提供者**：自定义认证和授权机制
