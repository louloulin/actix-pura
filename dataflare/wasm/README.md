# DataFlare Enterprise
## ä¼ä¸šçº§é«˜æ€§èƒ½æµå¤„ç†å¹³å°

DataFlare Enterprise æ˜¯åŸºäº `@dataflare/plugin` æ„å»ºçš„ä¼ä¸šçº§æµå¤„ç†å¹³å°ï¼Œä¸“æ³¨äºä¸ºå¤§å‹ä¼ä¸šæä¾›é«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€å®‰å…¨åˆè§„çš„æ•°æ®æµå¤„ç†èƒ½åŠ›ã€‚

## ğŸ¯ æ ¸å¿ƒå®šä½

### ä¼ä¸šçº§æµå¤„ç†å¹³å°
- **é«˜æ€§èƒ½æµå¤„ç†**: å€Ÿé‰´ Fluvio è®¾è®¡ï¼Œæ”¯æŒ >1M è®°å½•/ç§’ååé‡
- **åˆ†å¸ƒå¼è®¡ç®—**: åŸºäº WASM çš„åˆ†å¸ƒå¼æ•°æ®å¤„ç†å¼•æ“
- **ä¼ä¸šçº§ç›‘æ§**: å…¨é¢çš„å¯è§‚æµ‹æ€§ã€å‘Šè­¦å’Œè¿ç»´ä½“ç³»
- **å®‰å…¨åˆè§„**: ä¼ä¸šçº§å®‰å…¨ã€åŠ å¯†ã€å®¡è®¡å’Œæƒé™ç®¡ç†

### ä¸ @dataflare/plugin çš„å…³ç³»
- **åŸºç¡€ä¾èµ–**: åŸºäº `@dataflare/plugin` çš„æ’ä»¶ç³»ç»Ÿæ„å»º
- **åŠŸèƒ½äº’è¡¥**: ä¸“æ³¨ä¼ä¸šçº§ç‰¹æ€§ï¼Œé¿å…åŠŸèƒ½é‡å¤
- **æ¶æ„ååŒ**: åˆ©ç”¨æ’ä»¶ç³»ç»Ÿçš„é›¶æ‹·è´å’Œé«˜æ€§èƒ½ç‰¹æ€§

## ğŸš€ ä¼ä¸šçº§åŠŸèƒ½

### ğŸŒŠ é«˜æ€§èƒ½æµå¤„ç†
- **é›¶æ‹·è´å¤„ç†**: åŸºäº Fluvio è®¾è®¡çš„é›¶æ‹·è´æ•°æ®å¤„ç†
- **æ™ºèƒ½èƒŒå‹æ§åˆ¶**: è‡ªé€‚åº”æµé‡æ§åˆ¶å’Œè´Ÿè½½ç®¡ç†
- **æµå¼èšåˆ**: å®æ—¶çª—å£è®¡ç®—å’Œèšåˆåˆ†æ
- **äº‹ä»¶é©±åŠ¨**: å®Œæ•´çš„äº‹ä»¶å¤„ç†å’Œé‡æ”¾æœºåˆ¶

### ğŸ—ï¸ åˆ†å¸ƒå¼è®¡ç®—
- **é›†ç¾¤ç®¡ç†**: 1000+ èŠ‚ç‚¹çš„å¤§è§„æ¨¡é›†ç¾¤ç®¡ç†
- **ä»»åŠ¡è°ƒåº¦**: æ™ºèƒ½ä»»åŠ¡åˆ†å‘å’Œè´Ÿè½½å‡è¡¡
- **æ•…éšœæ¢å¤**: è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œå¿«é€Ÿæ¢å¤
- **å¼¹æ€§æ‰©ç¼©**: åŸºäºè´Ÿè½½çš„è‡ªåŠ¨æ‰©ç¼©å®¹

### ğŸ“Š ä¼ä¸šçº§ç›‘æ§
- **å…¨é¢ç›‘æ§**: ä¸šåŠ¡ã€ç³»ç»Ÿã€æ€§èƒ½ã€å®‰å…¨å¤šç»´åº¦ç›‘æ§
- **åˆ†å¸ƒå¼è¿½è¸ª**: ç«¯åˆ°ç«¯çš„è¯·æ±‚è¿½è¸ªå’Œæ€§èƒ½åˆ†æ
- **æ™ºèƒ½å‘Šè­¦**: åŸºäºæœºå™¨å­¦ä¹ çš„æ™ºèƒ½å‘Šè­¦å’Œé¢„æµ‹
- **è¿ç»´è‡ªåŠ¨åŒ–**: è‡ªåŠ¨åŒ–è¿ç»´å’Œæ•…éšœå¤„ç†

### ğŸ”’ å®‰å…¨åˆè§„
- **å¤šå±‚å®‰å…¨**: è®¤è¯ã€æˆæƒã€åŠ å¯†ã€å®¡è®¡å…¨æ–¹ä½å®‰å…¨
- **åˆè§„ç®¡ç†**: SOC2ã€GDPRã€HIPAA ç­‰åˆè§„è¦æ±‚æ”¯æŒ
- **æ•°æ®ä¿æŠ¤**: ç«¯åˆ°ç«¯æ•°æ®åŠ å¯†å’Œéšç§ä¿æŠ¤
- **å®¡è®¡è¿½è¸ª**: 100% æ“ä½œå®¡è®¡å’Œåˆè§„æŠ¥å‘Š

## å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ä½¿ç”¨

```rust
use dataflare_wasm::*;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // åˆ›å»º WASM è¿è¡Œæ—¶
    let mut runtime = WasmRuntime::new().await?;

    // åŠ è½½æ’ä»¶
    let plugin_config = WasmPluginConfig {
        name: "my_plugin".to_string(),
        module_path: "./plugins/my_plugin.wasm".to_string(),
        config: HashMap::new(),
        security_policy: sandbox::SecurityPolicy::default(),
        memory_limit: 16 * 1024 * 1024, // 16MB
        timeout_ms: 10000,
    };

    let plugin_id = runtime.load_plugin("./plugins/my_plugin.wasm", plugin_config).await?;

    // æ‰§è¡Œæ’ä»¶å‡½æ•°
    let result = runtime.call_function(&plugin_id, "process_data", vec![
        serde_json::json!({"input": "test_data"})
    ]).await?;

    println!("æ’ä»¶æ‰§è¡Œç»“æœ: {:?}", result);
    Ok(())
}
```

### 2. ç»„ä»¶ç®¡ç†

```rust
use dataflare_wasm::components::*;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // åˆ›å»ºç»„ä»¶ç®¡ç†å™¨
    let mut manager = WasmComponentManager::new();

    // æ³¨å†Œ Source ç»„ä»¶
    let source_config = WasmComponentConfig {
        component_type: WasmComponentType::Source,
        name: "csv_source".to_string(),
        module_path: "./plugins/csv_source.wasm".to_string(),
        config: Some({
            let mut config = HashMap::new();
            config.insert("file_path".to_string(), serde_json::json!("./data/input.csv"));
            config
        }),
        runtime_config: None,
        metadata: None,
    };

    manager.register_component(source_config).await?;

    // è·å–ç»„ä»¶ç»Ÿè®¡ä¿¡æ¯
    let stats = manager.get_stats();
    println!("ç»„ä»¶ç»Ÿè®¡: {:?}", stats);

    Ok(())
}
```

## æ’ä»¶å¼€å‘

### 1. æ’ä»¶ç»“æ„

WASM æ’ä»¶éœ€è¦å®ç°ä»¥ä¸‹æ ‡å‡†æ¥å£ï¼š

```rust
// æ’ä»¶åˆå§‹åŒ–
#[no_mangle]
pub extern "C" fn plugin_init(config_ptr: *const u8, config_len: usize) -> i32 {
    // åˆå§‹åŒ–æ’ä»¶
    0 // è¿”å› 0 è¡¨ç¤ºæˆåŠŸ
}

// æ•°æ®å¤„ç†
#[no_mangle]
pub extern "C" fn process_data(data_ptr: *const u8, data_len: usize) -> i32 {
    // å¤„ç†æ•°æ®
    0 // è¿”å›å¤„ç†ç»“æœçš„æŒ‡é’ˆ
}

// æ’ä»¶æ¸…ç†
#[no_mangle]
pub extern "C" fn plugin_cleanup() -> i32 {
    // æ¸…ç†èµ„æº
    0
}
```

### 2. ç»„ä»¶ç±»å‹

#### Source ç»„ä»¶
```rust
// æ•°æ®æºç»„ä»¶ç¤ºä¾‹
#[no_mangle]
pub extern "C" fn read_data() -> i32 {
    // ä»æ•°æ®æºè¯»å–æ•°æ®
    // è¿”å›æ•°æ®æŒ‡é’ˆ
}
```

#### Transformer ç»„ä»¶
```rust
// æ•°æ®è½¬æ¢ç»„ä»¶ç¤ºä¾‹
#[no_mangle]
pub extern "C" fn transform_data(input_ptr: *const u8, input_len: usize) -> i32 {
    // è½¬æ¢æ•°æ®æ ¼å¼
    // è¿”å›è½¬æ¢åçš„æ•°æ®
}
```

#### Filter ç»„ä»¶
```rust
// æ•°æ®è¿‡æ»¤ç»„ä»¶ç¤ºä¾‹
#[no_mangle]
pub extern "C" fn filter_data(input_ptr: *const u8, input_len: usize) -> i32 {
    // è¿‡æ»¤æ•°æ®
    // è¿”å›è¿‡æ»¤ç»“æœ
}
```

## é…ç½®è¯´æ˜

### æ’ä»¶é…ç½®

```json
{
  "name": "my_plugin",
  "type": "transformer",
  "module_path": "./plugins/my_plugin.wasm",
  "config": {
    "param1": "value1",
    "param2": 42
  },
  "security_policy": {
    "allow_network": false,
    "allow_file_system": true,
    "allow_env_vars": false,
    "max_memory": 16777216,
    "max_execution_time": 10000,
    "allowed_paths": ["./data/"]
  },
  "memory_limit": 16777216,
  "timeout_ms": 10000,
  "metadata": {
    "author": "Your Name",
    "version": "1.0.0",
    "description": "æ’ä»¶æè¿°"
  }
}
```

### å®‰å…¨ç­–ç•¥

```rust
use dataflare_wasm::sandbox::SecurityPolicy;

let policy = SecurityPolicy {
    allow_network: false,        // ç¦æ­¢ç½‘ç»œè®¿é—®
    allow_file_system: true,     // å…è®¸æ–‡ä»¶ç³»ç»Ÿè®¿é—®
    allow_env_vars: false,       // ç¦æ­¢ç¯å¢ƒå˜é‡è®¿é—®
    max_memory: 16 * 1024 * 1024, // æœ€å¤§å†…å­˜ 16MB
    max_execution_time: 10000,   // æœ€å¤§æ‰§è¡Œæ—¶é—´ 10ç§’
    allowed_paths: vec!["./data/".to_string()], // å…è®¸è®¿é—®çš„è·¯å¾„
    allowed_hosts: vec![],       // å…è®¸è®¿é—®çš„ä¸»æœº
    allowed_env_vars: vec![],    // å…è®¸è®¿é—®çš„ç¯å¢ƒå˜é‡
};
```

## ä¸»æœºå‡½æ•°

WASM æ’ä»¶å¯ä»¥è°ƒç”¨ä»¥ä¸‹ä¸»æœºå‡½æ•°ï¼š

### æ—¥å¿—å‡½æ•°
```rust
// åœ¨æ’ä»¶ä¸­è°ƒç”¨
host_log("info", "è¿™æ˜¯ä¸€æ¡æ—¥å¿—æ¶ˆæ¯");
```

### æ—¶é—´å‡½æ•°
```rust
// è·å–å½“å‰æ—¶é—´æˆ³
let timestamp = host_get_time();
```

### éšæœºæ•°å‡½æ•°
```rust
// ç”Ÿæˆéšæœºæ•°
let random_value = host_random();
```

## é”™è¯¯å¤„ç†

```rust
use dataflare_wasm::{WasmError, WasmResult};

fn handle_plugin_error(result: WasmResult<String>) {
    match result {
        Ok(value) => println!("æˆåŠŸ: {}", value),
        Err(WasmError::Configuration(msg)) => eprintln!("é…ç½®é”™è¯¯: {}", msg),
        Err(WasmError::Runtime(msg)) => eprintln!("è¿è¡Œæ—¶é”™è¯¯: {}", msg),
        Err(WasmError::PluginLoad(msg)) => eprintln!("æ’ä»¶åŠ è½½é”™è¯¯: {}", msg),
        Err(WasmError::PluginExecution(msg)) => eprintln!("æ’ä»¶æ‰§è¡Œé”™è¯¯: {}", msg),
        Err(e) => eprintln!("å…¶ä»–é”™è¯¯: {}", e),
    }
}
```

## æ€§èƒ½ä¼˜åŒ–

### 1. å†…å­˜ç®¡ç†
- è®¾ç½®åˆé€‚çš„å†…å­˜é™åˆ¶
- åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„èµ„æº
- ä½¿ç”¨æµå¼å¤„ç†å¤„ç†å¤§æ•°æ®

### 2. æ‰§è¡Œä¼˜åŒ–
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- ä½¿ç”¨å¼‚æ­¥æ‰§è¡Œé¿å…é˜»å¡
- æ‰¹é‡å¤„ç†æ•°æ®æé«˜æ•ˆç‡

### 3. ç¼“å­˜ç­–ç•¥
- ç¼“å­˜ç¼–è¯‘åçš„ WASM æ¨¡å—
- å¤ç”¨æ’ä»¶å®ä¾‹
- é¢„åŠ è½½å¸¸ç”¨æ’ä»¶

## æµ‹è¯•

è¿è¡Œæµ‹è¯•ï¼š

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cargo test --manifest-path dataflare/wasm/Cargo.toml

# è¿è¡Œé›†æˆæµ‹è¯•
cargo test --manifest-path dataflare/wasm/Cargo.toml integration_tests

# è¿è¡Œç‰¹å®šæµ‹è¯•
cargo test --manifest-path dataflare/wasm/Cargo.toml test_wasm_runtime_creation
```

## ç¤ºä¾‹

æŸ¥çœ‹ `examples/` ç›®å½•ä¸­çš„ç¤ºä¾‹é…ç½®å’Œæ’ä»¶ä»£ç ã€‚

## è´¡çŒ®

æ¬¢è¿è´¡çŒ®ä»£ç å’Œæå‡ºå»ºè®®ï¼è¯·æŸ¥çœ‹é¡¹ç›®çš„è´¡çŒ®æŒ‡å—ã€‚

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚
